--- 
title: "Análisis de 4 grupos de alturas de superficie corneales (cornea data)"
author: "Dr. Jaime Lincovil C."
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_floot: yes
  pdf_document:
    toc: yes
  html_notebook:
    toc: yes
    toc_floot: yes
  word_document:
    toc: yes
documentclass: book
link-citations: yes
site: bookdown::bookdown_site   
biblio-style: apalike
header-includes:
- \usepackage{placeins}
---



#  Estudio descriptivo  

```{r,  include=FALSE, eval=TRUE}
library(wavethresh)
library(gtools)
library(purrr)
library(corrr)
library(DelayedArray)
library(kableExtra)
```

El conjunto de datos proviene de un estudio de *ceratocone* realizado por N. Tripoli
y el Dr. K. L. Cohen del Departamento de Oftalmología de la Universidad de Carolina
del
Norte en *Chapel Hill*. Se derivaron de un procedimiento de regularización que
emplea
una base polinomial de *Zernike* en una cuadrícula de ubicación polar, donde las
alturas se estiman mediante regresión paramétrica. Para obtener más detalles sobre
cómo se obtuvieron los datos, el lector puede consultar la sección 4 de  Smaga &
Zhaga (2019).
El conjunto de curvas está formado por $n_1 = 43$, $n_2 = 14$, $n_3 = 21$ y 
$n_4 = 72$ observaciones de $r = 4$ grupos: *Normal*, *Unilateral-Suspect*,
*Suspect-Map* y *Clinical- Keratoconus*, respectivamente. Los datos originales
tienen 2000 puntos en cada observación, los cuales han sido normalizados. Para
asegurar que el número de observaciones sea una potencia de 2, aplicamos el
procedimiento de extensión de espejo completando 2048 puntos en cada observación.

Solo existe un articulo en la literatura científica que estudia la diferencia entre
grupos de altura corneal con estos datos. Smaga &
Zhaga (2019) aplico procedimientos de Analisis de la Varianza funcional (FANOVA).
Los procedimientos de prueba empleados rechazan la hipótesis nula de equivalencia en
las alturas superficiales de las córneas promedio en los cuatro grupos. Los autores
también probaron la hipótesis de la misma media funcional comparando un par de
casos, rechazando la hipótesis nula (con la excepción de un caso).

```{r,  include=FALSE, eval=TRUE}
# I Reading corneal data
corneal <- read.table("/home/jaime/Dropbox/Administrativo/Administrativo(2022)/Postulación_trabajo_2022/postulacion_utem_2022/Rmd_utem/Rmd_utem1/CornealDataSet.txt", header = FALSE,                       sep = "", comment.char = "%")
corneal <- t(as.data.frame(corneal))
## Indexes of the groups pf corneas
corneal.label <- c( rep(1, 43), rep(2, 14), rep(3, 21), rep(4, 72) )
## II Extendending data to a power of 2
a1= 24 ; a2 = 24
corneal.0 <- matrix(0, ncol = 150, nrow= 2^11) 
for (s in 1:150) {
  HEAD <- rev( head( corneal[,s], n = a1 ) )
  TAIL <- rev( tail( corneal[,s], n = a2 ) )
  
  corneal.0[,s] <-      c(HEAD,corneal[,s], TAIL)
}

## Rescaling data in [0,1]
norm <- function(a) (a-min(a))/(max(a)-min(a))
cornea_norm <- matrix(0, ncol= dim(corneal.0)[2], nrow = dim(corneal.0)[1] )
for (i in 1:dim(corneal.0)[2]) {
  cornea_norm[,i]  <- norm(corneal.0[,i])
}
#  Rescaled times in [0,1]
cornea_time <- (1:dim(corneal.0)[1])/dim(corneal.0)[1] 
## data and mean separately
col1 = rainbow(length(unique(corneal.label)))[1]
col2 = rainbow(length(unique(corneal.label)))[4]
col3 = rainbow(length(unique(corneal.label)))[3]
col4 = rainbow(length(unique(corneal.label)))[2]


```

  
```{r,  echo=FALSE, include = TRUE, eval=TRUE, warning=FALSE, message=FALSE}

matplot(cornea_time , cornea_norm[, which(corneal.label == 4)], 
         type = "l", lwd = 1, lty = 1,
         col = col1, 
         xlim = NULL,  ylim = NULL,
         xlab="Rescaled n° of entries", ylab= "Rescaled Height corneal surface")

matlines(cornea_time, cornea_norm[, which(corneal.label == 3)], 
         type = "l", lty = 1, col = col2, lwd=1)
matlines(cornea_time, cornea_norm[, which(corneal.label == 2)], 
         type = "l", lty = 1, lwd=1, col = col3 )
matlines(cornea_time, cornea_norm[, which(corneal.label == 1)],
         type = "l", lty = 1, lwd=0.3,  col = col4)
legend( 0.0, 0.35 ,   lty=1, lwd = 2,
        legend = c("Keratoconus",  "Suspect",  "Unilateral", "Normal"), 
        col= c(col1, col2, col3, col4), cex=0.7)

```

```{r,  echo=FALSE, include = TRUE, eval=TRUE, warning=FALSE, message=FALSE}
matplot(cornea_time, cornea_norm[,c(1, 44, 58, 79)], 
         type = "l", lwd = 1.2, lty = 1,
         col = c(col1, col2, col3, col4), 
         xlim = NULL,  ylim = NULL,
         xlab="Rescaled n° of entries", ylab= "Rescaled mean of hights corneal surface")

legend( 0.0, 0.4 ,   lty=1, lwd = 2,
        legend =c("Keratoconus", "Suspect", "Unilateral","Normal"), 
        col= c(col1, col2, col3, col4), cex=0.7)
```

```{r,  echo=FALSE, include = TRUE, eval=TRUE, warning=FALSE, message=FALSE}
j1 <- 10 ; j0 <- 7 ;
type = "hard"; policy = "LSuniversal"; dev = "madmad"
# corneal.label <- c( rep(1, 43), rep(2, 14), rep(3, 21), rep(4, 72) )
# cjk observation 1
decom1 <- wd(cornea_norm[,1 ], filter= 5, family  = "DaubLeAsymm")
decom.th1 <- threshold(decom1, levels = (j0-1):(j1-1), 
                       type = "soft", policy = "sure", by.level= TRUE)
# cjk mean2
decom2 <- wd(cornea_norm[, 44], filter= 5, family  = "DaubLeAsymm")
decom.th2 <- threshold(decom2, levels = (j0-1):(j1-1), 
                       type = "soft", policy = "sure", by.level= TRUE)
# cjk mean3
decom3 <- wd(cornea_norm[,58 ], filter= 5, family  = "DaubLeAsymm")
decom.th3 <- threshold(decom3, levels = (j0-1):(j1-1), 
                       type = "soft", policy = "sure", by.level= TRUE)
# cjk mean4
decom4 <- wd(cornea_norm[,79 ], filter= 5, family  = "DaubLeAsymm")
decom.th4 <- threshold(decom4, levels = (j0-1):(j1-1), 
                       type = "soft", policy = "sure", by.level= TRUE)
c1 <- accessC(decom.th1, level = j0-1)
c2 <- accessC(decom.th2, level = j0-1)
c3 <- accessC(decom.th3, level = j0-1)
c4 <- accessC(decom.th4, level = j0-1)

barplot(cbind(c1,c2,c3,c4),
        beside=TRUE,
        names.arg = c("Keratoconus", "Suspect", "Unilateral","Normal"),
        main = "")

```

# Estudio Inferencial: ¿las alturas de las superficies de cada tipo de cornea son diferentes?

El alcance de nuestra propuesta considera modelar grupos de curvas  r 
  mediante modelos funcionales  $Y_{il} (t)$ que satisfacen la condición
$$
d Y_{il}(t)= f_{i}(t)dt + \epsilon d W_{il}(t), \quad i=1,\ldots, r, ; \quad l=1,\ldots n_i ; \quad t\in[0,1],
$$
donde $\epsilon> 0$ es el llamado coeficiente de difusión, $f_ {i} (t) \in B_ {pq} ^ {o} (C)$ (un espacio de Besov en $[0,1] $ con radio $C > 0$) y $W_{il}(t)$ es una secuencia de procesos estocásticos débilmente estacionarios con media cero, cuyas realizaciones son independientes. Consideremos que la componente sistemática $f_{i}(t)$ tiene la siguiente descomposición
$$
f_{i}(t) = m+ \mu(t) + g_{i}(t), \quad i=1,\ldots, r; \quad t \in [0,1],
$$
donde $m$ es una constante, $\mu(t)$ es cero o una función no constante de $t$ (el efecto principal de $t$), y $g_{i}(t)$ es una función que contiene la interacción entre el $i$ésimo grupo y el tiempo $t$. La función $g_{i}(t)$ será una función distinta de cero o distinta de cero que no se puede descomponer como una suma de $i$ y una función de $t$. Como generalmente se establece en la literatura, es necesario que $\mu (t)$ y $g_ {i} (t)$ satisfagan algunas condiciones de identificabilidad.

En la literatura existen algunas propuestas para testar $H_0$. Por ejemplo, Ingster (2012) presenta una descripción general de los procedimientos de hipótesis asintóticamente funcionales *minimax* para probar una función nula ($f_i(t) = 0$) en un modelo gaussiano de ''señal más ruido'', considerando varios distancias de separación entre la hipótesis nula y la alternativa. Basado en esto, Abramovich et al. (2004) propone una prueba de hipótesis para las hipótesis $\mu(t)=0$ y $g_{i}(t)=0$.

```{r,  echo=FALSE, include = TRUE, eval=TRUE, warning=FALSE, message=FALSE}
library(EnvStats)
boot <- read.csv("/home/jaime/Dropbox/Administrativo/Administrativo(2022)/Postulación_trabajo_2022/postulacion_utem_2022/Rmd_utem/Rmd_utem1/boot.dist.corneal.3.csv", sep = ",", header= TRUE)
boot1.1 <- boot$V1[1:2000]
boot1.2 <- boot$V1

q1.1 <- qemp(p = seq(0, 1, len = 100), obs = boot1.1*1e+5)
q1.2 <- qemp(p = seq(0, 1, len = 100), obs = boot1.2*1e+5)
den1.1 <- demp(q1.1, boot1.1*1e+5, discrete = FALSE, density.arg.list = NULL)
den1.2 <- demp(q1.2, boot1.2*1e+5, discrete = FALSE, density.arg.list = NULL)

matplot(q1.1, den1.1, main="",
     xlab = expression(paste("Computed B"[n], " x 10"^5 )),
     ylab = "", ylim= c(0, 0.2),
     lty = 1, type="l", lwd=1.5)

matpoints(q1.2, den1.2, lty = 3, type="l", lwd=3)

legend( 9, 0.2, lwd = c(1.5,3), lty = c(1,3),
        legend = c( "B=2000", "B=10000"),
        col=c("black", "black"),  
        cex=0.7)

```


| Q1  | Q2  | Q3    |  Bn x 10^5 | P-valor|
|:--- |:---: |:---: | :---:      | ---:   |
||| B=2000|||
|-2.048|-0.367|1.735|5.382 |  0.058      |
|:--- |:---: |:---:   | :---:          | ---:   |
||| B=10000|||
|-2.031|-0.463| 1.567 | -  |0.051 |
|:--- |:---: |:---:   | :---:     | ---:   |

Finalmente, estudiamos la densidad estimada de la distribución
*bootstrap* de $B_n$. La Figura ? muestra la densidad estimada de $B_n$
para muestras de tamaño $2000$ y $10000$. Notamos que ambas no difieren
mucho entre sí en términos de dispersión, aunque ambas están centrados
alrededor de -0.35 y ligeramente sesgados hacia la derecha. En la Tabla
? enumeramos los cuartiles, el valor observado de $B_n$ y los
respectivos p-valores  de *bootstrap* para $H_0$. En esta tabla,
confirmando lo observado en la Figura de las densidades, no observamos
grandes diferencias en los cuartiles, obteniendo p-valores muy cercanos. **Con
base en los p-valores, con $5\%$ de significancia, no rechazamos $H_0$,
es decir, concluimos que en relación a la muestra, las curvas de altura
corneal no son significativamente diferentes**.

## Referencias 

- Smaga, Ł., & Zhang, J. T. (2019). Linear hypothesis testing with functional data. Technometrics, 61(1), 99-110.

- Abramovich, F., Antoniadis, A., Sapatinas, T., & Vidakovic, B. (2004). Optimal testing in a fixed-effects functional analysis of variance model. International Journal of Wavelets, Multiresolution and Information Processing, 2(04), 323-349.

